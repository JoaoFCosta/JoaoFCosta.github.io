<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta
    name="description"
    content="Post on how to mock asynchronous (asyncio) functions in Python using pytest.">


  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@joaofcosta" />
  <meta name="twitter:title" content="Mocking Asynchronous Functions Python" />
  <meta name="twitter:description" content="Post on how to mock asynchronous (asyncio) functions in Python using pytest." />
  <meta name="twitter:image" content="https://i.imgur.com/ilEldyU.jpg" />

  <meta name="generator" content="Hugo 0.55.6" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Mocking Asynchronous Functions Python &middot; dino (dot) codes</title>

  
  <link type="text/css" rel="stylesheet" href="http://www.dino.codes/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://www.dino.codes/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://www.dino.codes/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://www.dino.codes/css/hyde.css">
  <link type="text/css" rel="stylesheet" href="http://www.dino.codes/css/override.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro|Playfair+Display|Fira+Mono">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://www.dino.codes/"><h1>dino (dot) codes</h1></a>
      <p class="lead">
       Thoughts and opinions on Software Development and Music Production. 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://www.dino.codes/">Home</a> </li>
        <li><a href="https://github.com/joaofcosta/"> Github </a></li><li><a href="https://medium.com/@dinojoaocosta"> Medium </a></li><li><a href="https://soundcloud.com/dino-costa-180136083"> Soundcloud </a></li><li><a href="https://twitter.com/joaofcosta_"> Twitter </a></li>
      </ul>
    </nav>

    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Mocking Asynchronous Functions Python</h1>
  <time datetime=2020-02-18T22:12:15Z class="post-date">Tue, Feb 18, 2020</time>
  

<h3 id="introduction">Introduction</h3>

<p>You might have already heard about Python&rsquo;s <code>asyncio</code> module, it allows you to easily run concurrent
code using Python.
In the last few months I&rsquo;ve worked in some codebases which take advantage of the benefits of
<code>asyncio</code>, mainly through the use of <a href="https://docs.aiohttp.org/en/stable/">aiohttp</a>.</p>

<p>When using <code>asyncio</code> you&rsquo;ll use the <code>async/await</code> keywords to both define and call
asynchronous functions.
This also means changes in the way you test your code because you can&rsquo;t simply call
an asynchronous function by its name anymore, that will only return a coroutine object,
you need to use the <code>await</code> keyword in order to actually schedule and run it.</p>

<p>As such, let&rsquo;s take a quick look into how we can easily test asynchronous functions by leveraging
<a href="https://docs.python.org/3/library/concurrent.futures.html">Futures</a>.</p>

<h3 id="what-we-re-mocking">What we&rsquo;re mocking</h3>

<p>In this example, we&rsquo;re going to be mocking a simple function with adds two integers, its parameters,
while resorting to <code>asyncio.sleep</code> to simulate IO heavy tasks, for example, HTTP requests or a
database calls.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> <span style="color:#111">asyncio</span>

<span style="color:#111">async</span> <span style="color:#00a8c8">def</span> <span style="color:#75af00">sum</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">,</span> <span style="color:#111">y</span><span style="color:#111">):</span>
    <span style="color:#111">await</span> <span style="color:#111">asyncio</span><span style="color:#f92672">.</span><span style="color:#111">sleep</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">x</span> <span style="color:#f92672">+</span> <span style="color:#111">y</span></code></pre></div>
<h3 id="mocking-it">Mocking it</h3>

<p>Asynchronous functions in Python return what&rsquo;s known as a <code>Future</code> object, which contains the
result of calling the asynchronous function.
As such, the &ldquo;secret&rdquo; to mocking these functions is to make the patched function return a
<code>Future</code> object with the result we&rsquo;re expecting as one can see in the example below.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> <span style="color:#111">pytest</span> <span style="color:#111">import</span> <span style="color:#111">asyncio</span>

<span style="color:#75af00">@pytest.fixture</span><span style="color:#111">()</span>
<span style="color:#00a8c8">def</span> <span style="color:#75af00">mock_sum</span><span style="color:#111">(</span><span style="color:#111">mocker</span><span style="color:#111">):</span>
    <span style="color:#111">future</span> <span style="color:#f92672">=</span> <span style="color:#111">asyncio</span><span style="color:#f92672">.</span><span style="color:#111">Future</span><span style="color:#111">()</span>
    <span style="color:#111">future</span><span style="color:#f92672">.</span><span style="color:#111">set_result</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">)</span>
    <span style="color:#111">mocker</span><span style="color:#f92672">.</span><span style="color:#111">patch</span><span style="color:#111">(</span><span style="color:#d88200">&#39;app.sum&#39;</span><span style="color:#111">,</span> <span style="color:#111">return_value</span><span style="color:#f92672">=</span><span style="color:#111">future</span><span style="color:#111">)</span></code></pre></div>
<p>As you can see in the example above, we&rsquo;re creating a pytest fixture, namely <code>mock_sum</code> which
patches the function we created at the beginning of the post and specifies that the function call
will return a <code>Future</code> object, with a result of <code>4</code>.
In your own tests you will, of course, need to change the call to <code>set_result</code> to return whatever
result you&rsquo;re expecting, maybe a HTTP request or some database query result.</p>

<p>With this done we can now create a simple test case that tests the <code>sum</code> function:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> <span style="color:#111">pytest</span> <span style="color:#111">import</span> <span style="color:#111">asyncio</span>

<span style="color:#75af00">@pytest.mark.asyncio</span>
<span style="color:#111">async</span> <span style="color:#00a8c8">def</span> <span style="color:#75af00">test_sum</span><span style="color:#111">(</span><span style="color:#111">mock_sum</span><span style="color:#111">):</span>
    <span style="color:#111">result</span> <span style="color:#f92672">=</span> <span style="color:#111">await</span> <span style="color:#111">sum</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
    <span style="color:#75715e"># I know 1+2 is equal to 3 but one man can only dream!</span>
    <span style="color:#00a8c8">assert</span> <span style="color:#111">result</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span></code></pre></div>
<p>There&rsquo;s also a few different things happening here when compared to a regular test function:</p>

<ul>
<li><code>@pytest.mark.asyncio</code> decorator - This tells pytest that this is an asynchronous test function,
otherwise pytest will skip it.</li>
<li><code>async def test_sum(mock_sum)</code> - Defines the asynchronous test function while at the same time
calls the pytest fixture, <code>mock_sum</code>, so that it successfully mocks the <code>sum</code> function&rsquo;s result.</li>
<li><code>result = await sum(1,2)</code> - Correctly calls the asynchronous function using the <code>await</code> keyword.</li>
</ul>

<p>Although <code>1 + 2</code> is equal to <code>3</code> I&rsquo;m purposefully asserting that this returns <code>4</code> so as to make sure
that the fixture is indeed called.
If you go ahead and run <code>pytest</code> now with the code shown above you should see that indeed it
executes successfully, passing the tests.</p>

<h3 id="conclusion">Conclusion</h3>

<p>In conclusion mocking asynchronous in Python is actually easier than I expected at first, mostly
because I didn&rsquo;t really understood how asyncio worked. After some reading and experimentation it
turns out it&rsquo;s quick and easy to do, and it allows you to run concurrent tests, which should speed
up your test suite.</p>

<p>If you&rsquo;re reading this for a quick solution and don&rsquo;t really known what&rsquo;s going on I&rsquo;d advise
<a href="https://realpython.com/async-io-python/">reading up on asyncio</a>.</p>

<p>I hope this blogpost has helped you! 👋</p>

</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-144751197-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
